steps:
  - id: Generate Git Diff
    name: gcr.io/cloud-builders/git
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        git fetch origin
        git diff origin/main --output /workspace/diff.txt
        cat /workspace/diff.txt

  - id: Get the MR ID
    name: 'europe-west1-docker.pkg.dev/$PROJECT_ID/tools/friendly-cicd-helper'
    entrypoint: sh
    args:
    - -c
    - |
      MERGE_REQUEST_IID=$$(friendly-cicd-helper gitlab-mergerequest --project $_GITLAB_PROJECT --source $_HEAD_BRANCH)
      echo "$$MERGE_REQUEST_IID" > /workspace/gitlab_merge_request_iid
    secretEnv: ['GITLAB_TOKEN']

  - id: Using Vertex AI to provide an automated MR Review
    name: 'europe-west1-docker.pkg.dev/$PROJECT_ID/tools/friendly-cicd-helper'
    entrypoint: sh
    args:
    - -c
    - |
      export VERTEX_GCP_PROJECT=$PROJECT_ID
      echo "## Automated Merge Request Review Notes (generated by Vertex AI)" | tee mergerequest-review.md
      echo "_Note that the following notes do not replace a thorough code review by an expert:_" | tee -a mergerequest-review.md

      friendly-cicd-helper vertex-code-review --diff /workspace/diff.txt | tee -a mergerequest-review.md

      cat mergerequest-review.md | friendly-cicd-helper gitlab-comment --project $_GITLAB_PROJECT --mergerequest $$(cat /workspace/gitlab_merge_request_iid)
    secretEnv: ['GITLAB_TOKEN']

  - id: Using Vertex AI to provide automated Release Notes
    name: 'europe-west1-docker.pkg.dev/$PROJECT_ID/tools/friendly-cicd-helper'
    entrypoint: sh
    args:
    - -c
    - |
      export VERTEX_GCP_PROJECT=$PROJECT_ID
      echo "## Automated Suggestions for Release Notes (generated by Vertex AI)" | tee mergerequest-release-notes.md

      friendly-cicd-helper vertex-release-notes --diff /workspace/diff.txt | tee -a mergerequest-release-notes.md

      cat mergerequest-release-notes.md | friendly-cicd-helper gitlab-comment --project $_GITLAB_PROJECT --mergerequest $$(cat /workspace/gitlab_merge_request_iid)
    secretEnv: ['GITLAB_TOKEN']
  - id: Build the image with Skaffold
    name: gcr.io/k8s-skaffold/skaffold
    entrypoint: /bin/bash
    args:
      - -c
      - |
        skaffold build --interactive=false --file-output=/workspace/artifacts.json --default-repo=$_REPO
  - id: Create a release in Cloud Deploy and rollout to staging
    name: gcr.io/cloud-builders/gcloud
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        MERGE_REQUEST_IID=$$(cat /workspace/gitlab_merge_request_iid)
        gcloud deploy releases create ledgerwriter-${SHORT_SHA} --delivery-pipeline genai-sw-delivery \
          --region europe-west1 --annotations "commitId=${REVISION_ID},gitlab_mr=$$MERGE_REQUEST_IID" --build-artifacts /workspace/artifacts.json
availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/friendly-cicd-helper_gitlab/versions/1
    env: 'GITLAB_TOKEN'

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _GITLAB_PROJECT: galloro/genai-sw-delivery
